from paramiko import SSHClient, AutoAddPolicy
from scp import SCPClient


class Server:
    """
    The Server class provides methods to manage the connection to a remote machine through SSH authentication.
    """

    def __init__(self, hostname: str, username: str, password: str) -> None:
        """
        Initializes the authentication data to a remote machine.

        :param hostname: server to connect to
        :param username: username to authenticate as
        :param password: password used for authentication
        """

        self.hostname = hostname
        self.username = username
        self.password = password

    def make_remote_directory(self, directory: str) -> None:
        """
        Executes a command in a remote machine in order to make a directory.

        :param directory: remote directory name
        """

        # Creation of a new SSH client
        client = SSHClient()
        # Setting policy to use when connecting to the SSH server without a known host key
        client.set_missing_host_key_policy(AutoAddPolicy())
        # Connection to the SSH server and authentication
        client.connect(hostname=self.hostname, username=self.username, password=self.password)

        # Command: checks if the directory already exists, and make it if not
        command = f'if [ ! -d {directory} ]; then mkdir {directory}; fi'
        # Execution of the command in the remote machine
        _, _, _ = client.exec_command(command=command)

        # Closing the SSH client
        client.close()
    
    def transfer_file(self, local: str, remote: str) -> None:
        """
        Transfers a file from a local machine to a remote machine.

        :param local: local file name
        :param remote: remote directory name
        """

        # Creation of a new SSH client
        client = SSHClient()
        # Setting policy to use when connecting to the SSH server without a known host key
        client.set_missing_host_key_policy(AutoAddPolicy())
        # Connection to the SSH server and authentication
        client.connect(hostname=self.hostname, username=self.username, password=self.password)

        # Creation of a new SCP client
        with SCPClient(client.get_transport()) as scp:
            # Transfer through SCP
            scp.put(local, remote)

        # Closing the SSH client
        client.close()
